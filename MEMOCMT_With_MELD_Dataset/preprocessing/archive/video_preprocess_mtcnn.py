"""
video_preprocess_mtcnn.py

Face-centric video preprocessing for MELD (frame-based)

This script:
- Reads frames generated by video_preprocess.py
- Detects faces using MTCNN
- Crops and saves face-only frames
- Preserves utterance-level and temporal structure

INPUT:
data/MELD/<split>/frames/<utterance_id>/frame_XXXX.jpg

OUTPUT:
data/MELD/<split>/face_frames/<utterance_id>/face_XXXX.jpg

NOTE:
- This is an OPTIONAL enhancement
- It does NOT overwrite raw frames
- Used for face-focused visual analysis
"""

import os
import cv2
from glob import glob
from mtcnn import MTCNN

MELD_ROOT = "data/MELD"
SPLITS = ["train", "dev", "test"]
FRAME_DIR_NAME = "frames"
FACE_DIR_NAME = "face_frames"

detector = MTCNN()

def safe_crop(frame, box):
    x, y, w, h = box
    x = max(0, x)
    y = max(0, y)
    w = max(1, w)
    h = max(1, h)

    H, W, _ = frame.shape
    x2 = min(W, x + w)
    y2 = min(H, y + h)

    return frame[y:y2, x:x2]

def process_utterance(frame_dir, out_dir):
    os.makedirs(out_dir, exist_ok=True)

    frame_files = sorted(glob(os.path.join(frame_dir, "*.jpg")))
    saved = 0

    for idx, frame_path in enumerate(frame_files):
        frame = cv2.imread(frame_path)
        if frame is None:
            continue

        faces = detector.detect_faces(frame)
        if not faces:
            continue

        face = max(faces, key=lambda f: f["box"][2] * f["box"][3])
        crop = safe_crop(frame, face["box"])

        if crop.size == 0:
            continue

        out_path = os.path.join(out_dir, f"face_{idx:04d}.jpg")
        cv2.imwrite(out_path, crop)
        saved += 1

    return saved

def run():
    for split in SPLITS:
        frame_root = os.path.join(MELD_ROOT, split, FRAME_DIR_NAME)
        face_root = os.path.join(MELD_ROOT, split, FACE_DIR_NAME)

        if not os.path.exists(frame_root):
            print(f"[WARN] {split}: frames folder not found")
            continue

        os.makedirs(face_root, exist_ok=True)

        utterance_dirs = [
            d for d in os.listdir(frame_root)
            if os.path.isdir(os.path.join(frame_root, d))
        ]

        print(f"[{split}] Found {len(utterance_dirs)} utterances")

        total_faces = 0
        skipped = 0

        for utt_id in utterance_dirs:
            in_dir = os.path.join(frame_root, utt_id)
            out_dir = os.path.join(face_root, utt_id)

            saved = process_utterance(in_dir, out_dir)
            if saved == 0:
                skipped += 1
            total_faces += saved

        print(f"[{split}] Face frames saved: {total_faces}")
        print(f"[{split}] Utterances with no faces: {skipped}")

    print("Face-based video preprocessing completed successfully.")

if __name__ == "__main__":
    run()
